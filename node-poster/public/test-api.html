<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API测试与网络诊断</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .container { text-align: center; }
        button { padding: 10px 20px; margin: 10px 5px; border: none; border-radius: 4px; cursor: pointer; }
        .test-btn { background-color: #4CAF50; color: white; }
        .test-btn:hover { background-color: #45a049; }
        .diagnose-btn { background-color: #2196F3; color: white; }
        .diagnose-btn:hover { background-color: #0b7dda; }
        #result, #networkInfo { margin-top: 20px; text-align: left; background-color: #f5f5f5; padding: 15px; border-radius: 4px; }
        #posterImage { max-width: 100%; margin-top: 20px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>海报生成API测试</h1>
        <button id="testApi" class="test-btn">测试API</button>
        <button id="diagnoseNetwork" class="diagnose-btn">网络诊断</button>
        <div id="networkInfo">点击"网络诊断"按钮获取网络信息</div>
        <div id="result"></div>
        <img id="posterImage" src="" alt="生成的海报">
    </div>

    <script>
        // 网络诊断函数
        async function diagnoseNetwork() {
            const networkInfoDiv = document.getElementById('networkInfo');
            networkInfoDiv.innerHTML = '正在获取网络信息...';

            try {
                // 获取设备IP地址
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const publicIp = ipData.ip;

                // 检查网络连接状态
                const onlineStatus = navigator.onLine ? '在线' : '离线';

                // 检查到服务器的连接
                const serverCheckStart = Date.now();
                let serverReachable = false;
                let serverCheckTime = 0;
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
                    await fetch('http://192.168.190.207:3000', { signal: controller.signal });
                    clearTimeout(timeoutId);
                    serverReachable = true;
                    serverCheckTime = Date.now() - serverCheckStart;
                } catch (error) {
                    serverCheckTime = Date.now() - serverCheckStart;
                }

                // 显示网络信息
                networkInfoDiv.innerHTML = `
                    <strong>网络诊断结果:</strong><br>
                    公共IP地址: ${publicIp}<br>
                    网络状态: ${onlineStatus}<br>
                    服务器可达性: ${serverReachable ? '<span class="success">可达</span>' : '<span class="error">不可达</span>'}<br>
                    服务器响应时间: ${serverCheckTime}ms<br>
                    当前URL: ${window.location.href}<br>
                    浏览器: ${navigator.userAgent}<br>
                `;
            } catch (error) {
                networkInfoDiv.innerHTML = `<span class="error">网络诊断失败: ${error.message}</span>`;
            }
        }

        // 测试API函数
        async function testApi() {
            const resultDiv = document.getElementById('result');
            const posterImage = document.getElementById('posterImage');
            resultDiv.innerHTML = '正在请求API...';
            posterImage.src = '';

            try {
                const startTime = Date.now();
                const response = await fetch('http://192.168.190.207:3000/api/generate-crystal-poster', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        crystal_data: {
                            title: '测试海报',
                            stones: []
                        }
                    }),
                    timeout: 10000 // 10秒超时
                });
                const endTime = Date.now();

                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }

                const data = await response.json();
                resultDiv.innerHTML = `
                    <span class="success">请求成功!</span><br>
                    状态码: ${response.status}<br>
                    响应时间: ${endTime - startTime}ms<br>
                    响应: ${JSON.stringify(data).substring(0, 300)}${JSON.stringify(data).length > 300 ? '...' : ''}<br>
                `;

                if (data.data) {
                    posterImage.src = 'data:image/png;base64,' + data.data;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">请求失败:</span><br>${error.message}`;
                console.error('API请求错误:', error);
            }
        }

        // 绑定按钮事件
        document.getElementById('testApi').addEventListener('click', testApi);
        document.getElementById('diagnoseNetwork').addEventListener('click', diagnoseNetwork);

        // 页面加载时自动进行网络诊断
        window.addEventListener('load', function() {
            setTimeout(diagnoseNetwork, 1000);
        });
    </script>
</body>
</html>